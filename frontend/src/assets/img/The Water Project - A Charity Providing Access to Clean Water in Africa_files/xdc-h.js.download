/**
 * @fileoverview Cookie Handler Module for tracking and managing user identifiers
 * @version 1.3.0
 * @author Your Organization
 * @license MIT
 */

/**
 * Cookie Handler Module - Manages user identification through cookies and URL parameters
 * @namespace CookieHandler
 */
const CookieHandler = (function() {
	'use strict';

	/**
	 * Cookie configuration object
	 * @private
	 * @constant {Object}
	 */
	const CONFIG = {
		USER_ID_COOKIE: 'twp_user_id',
		ANONYMOUS_ID_COOKIE: 'twp_anonymous_id',
		SESSION_ID_COOKIE: 'twp_session_id',
		GCLID_COOKIE: 'twp_gclid',
		COOKIE_PATH: '/',
		COOKIE_DOMAIN: '.thewaterproject.org',
		RENEWAL_DAYS_THRESHOLD: 30,
		COOKIE_DURATION_DAYS: 365,
		SESSION_COOKIE_DURATION_DAYS: 1,
		GCLID_DURATION_DAYS: 90
	};

	/**
	 * UUID v4 validation pattern
	 * @private
	 * @constant {RegExp}
	 */
	const UUID_V4_PATTERN = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

	/**
	 * URL parameter names for user identification
	 * @private
	 * @constant {Object}
	 */
	const URL_PARAMS = {
		SFMC_ID: 'sfmc_id',
		UID: 'uid',
		GCLID: 'gclid'
	};

	/**
	 * Retrieves or sets the user ID from URL parameters or cookies
	 * @public
	 * @returns {string|null} The user ID if found, null otherwise
	 */
	function getUserId() {
		const queryStringId = getUserIdFromQueryString();
		if (queryStringId) {
			setCookie(CONFIG.USER_ID_COOKIE, queryStringId, CONFIG.COOKIE_DURATION_DAYS);
			cleanURLParameters();
			return queryStringId;
		}

		const cookieId = getCookie(CONFIG.USER_ID_COOKIE);
		if (cookieId) {
			// Validate existing cookie value - if invalid, clear it and return null
			if (!isValidUserId(cookieId)) {
				// Clear the invalid cookie by setting it to expire in the past
				setCookie(CONFIG.USER_ID_COOKIE, '', -1);
				return null;
			}
			
			if (shouldRenewCookie(CONFIG.USER_ID_COOKIE)) {
				setCookie(CONFIG.USER_ID_COOKIE, cookieId, CONFIG.COOKIE_DURATION_DAYS);
			}
			return cookieId;
		}
		return null;
	}

	/**
	 * Gets the anonymous ID from cookie, validates it, and regenerates if invalid
	 * @public
	 * @returns {string|null} The anonymous ID if found, null otherwise
	 */
	function getAnonymousId() {
		const cookieValue = getCookie(CONFIG.ANONYMOUS_ID_COOKIE);
		
		// If no cookie exists, return null (will be generated elsewhere)
		if (!cookieValue) {
			return null;
		}
		
		// Validate the cookie value
		if (!isValidUUID(cookieValue)) {
			// Invalid UUID detected - log to console and clear the cookie
			console.warn('[TWP Security] Invalid anonymous_id detected in cookie, regenerating');
			setCookie(CONFIG.ANONYMOUS_ID_COOKIE, '', -1); // Clear invalid cookie
			return null;
		}
		
		return cookieValue;
	}

	/**
	 * Gets the session ID from cookie, validates it, and regenerates if invalid
	 * @public
	 * @returns {string|null} The session ID if found, null otherwise
	 */
	function getSessionId() {
		const cookieValue = getCookie(CONFIG.SESSION_ID_COOKIE);
		
		// If no cookie exists, return null (will be generated elsewhere)
		if (!cookieValue) {
			return null;
		}
		
		// Validate the cookie value
		if (!isValidUUID(cookieValue)) {
			// Invalid UUID detected - log to console and clear the cookie
			console.warn('[TWP Security] Invalid session_id detected in cookie, regenerating');
			setCookie(CONFIG.SESSION_ID_COOKIE, '', -1); // Clear invalid cookie
			return null;
		}
		
		return cookieValue;
	}

	/**
	 * Retrieves or sets the GCLID from URL parameters or cookies
	 * @public
	 * @returns {string|null} The GCLID if found, null otherwise
	 */
	function getGclid() {
		const queryStringGclid = getGclidFromQueryString();
		if (queryStringGclid) {
			setCookie(CONFIG.GCLID_COOKIE, queryStringGclid, CONFIG.GCLID_DURATION_DAYS);
			return queryStringGclid;
		}

		const cookieGclid = getCookie(CONFIG.GCLID_COOKIE);
		if (cookieGclid) {
			if (shouldRenewCookie(CONFIG.GCLID_COOKIE)) {
				setCookie(CONFIG.GCLID_COOKIE, cookieGclid, CONFIG.GCLID_DURATION_DAYS);
			}
			return cookieGclid;
		}
		return null;
	}

	/**
	 * Sets a cookie with the specified name, value, and expiration
	 * @public
	 * @param {string} name - The name of the cookie
	 * @param {string} value - The value to store in the cookie
	 * @param {number} days - Number of days until the cookie expires
	 * @returns {void}
	 */
	function setCookie(name, value, days) {
		const date = new Date();
		date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));

		const cookieValue = encodeURIComponent(value);
		const isSecure = window.location.protocol === 'https:';
		const secureFlag = isSecure ? '; Secure' : '';
		const cookieString = `${name}=${cookieValue}; expires=${date.toUTCString()}; path=${CONFIG.COOKIE_PATH}; domain=${CONFIG.COOKIE_DOMAIN}; SameSite=Lax${secureFlag}`;

		document.cookie = cookieString;
	}

	/**
	 * Retrieves a cookie value by name
	 * @public
	 * @param {string} name - The name of the cookie to retrieve
	 * @returns {string|undefined} The cookie value if found, undefined otherwise
	 */
	function getCookie(name) {
		const cookieMatch = document.cookie.match(
			new RegExp('(^| )' + name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]+)')
		);
		return cookieMatch ? decodeURIComponent(cookieMatch[2]) : undefined;
	}

	/**
	 * Validates if a user ID is valid (not a template placeholder)
	 * @private
	 * @param {string} userId - The user ID to validate
	 * @returns {boolean} True if valid, false if invalid
	 */
	function isValidUserId(userId) {
		if (!userId || typeof userId !== 'string') {
			return false;
		}
		
		// Reject template placeholders like %%id%%, %%Id%%, or %%ID%%
		const templatePattern = /^%%[iI][dD]%%$/;
		return !templatePattern.test(userId.trim());
	}

	/**
	 * Validates if a UUID is properly formatted (UUID v4)
	 * @private
	 * @param {string} uuid - The UUID to validate
	 * @returns {boolean} True if valid UUID v4 format, false otherwise
	 */
	function isValidUUID(uuid) {
		if (!uuid || typeof uuid !== 'string') {
			return false;
		}
		return UUID_V4_PATTERN.test(uuid.trim());
	}

	/**
	 * Extracts user ID from URL parameters
	 * @private
	 * @returns {string|null} User ID from either sfmc_id or uid parameter
	 */
	function getUserIdFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		const sfmcId = urlParams.get(URL_PARAMS.SFMC_ID);
		const uid = urlParams.get(URL_PARAMS.UID);
		
		// Check sfmc_id first
		if (sfmcId && isValidUserId(sfmcId)) {
			return sfmcId;
		}
		
		// Check uid parameter
		if (uid && isValidUserId(uid)) {
			return uid;
		}
		
		return null;
	}

	/**
	 * Extracts GCLID from URL parameters
	 * @private
	 * @returns {string|null} GCLID parameter value if found, null otherwise
	 */
	function getGclidFromQueryString() {
		const urlParams = new URLSearchParams(window.location.search);
		return urlParams.get(URL_PARAMS.GCLID);
	}

	/**
	 * Removes tracking parameters from URL while preserving other parameters
	 * @private
	 * @returns {void}
	 */
	function cleanURLParameters() {
		const urlParams = new URLSearchParams(window.location.search);
		urlParams.delete(URL_PARAMS.SFMC_ID);
		urlParams.delete(URL_PARAMS.UID);
		// Note: We don't remove GCLID as Google recommends preserving it for attribution

		const newUrl = window.location.pathname +
			(urlParams.toString() ? `?${urlParams.toString()}` : '');

		window.history.replaceState({}, document.title, newUrl);
	}

	/**
	 * Retrieves the expiration date of a cookie
	 * @private
	 * @param {string} name - The name of the cookie
	 * @returns {Date|null} The expiration date if found, null otherwise
	 */
	function getCookieExpirationDate(name) {
		const cookies = document.cookie.split(';');
		const cookieString = cookies.find(row =>
			row.trim().startsWith(name + '=')
		);

		if (cookieString) {
			const expiresMatch = cookieString.match(/expires=([^;]+)/);
			return expiresMatch ? new Date(expiresMatch[1]) : null;
		}
		return null;
	}

	/**
	 * Determines if a cookie should be renewed based on its expiration date
	 * @private
	 * @param {string} name - The name of the cookie to check
	 * @returns {boolean} True if the cookie should be renewed, false otherwise
	 */
	function shouldRenewCookie(name) {
		const expirationDate = getCookieExpirationDate(name);
		if (!expirationDate) return false;

		const now = new Date();
		const renewalThreshold = new Date(
			now.getTime() + (CONFIG.RENEWAL_DAYS_THRESHOLD * 24 * 60 * 60 * 1000)
		);

		return expirationDate < renewalThreshold;
	}

	// Public API
	return {
		getUserId,
		getAnonymousId,
		getSessionId,
		getGclid,
		setCookie,
		getCookie
	};
})();

// Export for use in other modules if needed
if (typeof module !== 'undefined' && module.exports) {
	module.exports = CookieHandler;
} else {
	window.TWPCookie = CookieHandler; // Maintain backward compatibility
}